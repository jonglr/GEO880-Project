---
title: "Data Processing"
author: "Jon Guler, Michael Fehr"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

#Initialization
##Load and check Packages
```{r package management, echo=FALSE}

check_pkg <- function(x) {
  #' Checks whether a package is installed and installs or loads the package
  if (!require(x, character.only = TRUE, quietly = TRUE))
  {
    install.packages(x, dep = TRUE)
    if (!require(x, character.only = TRUE, quietly = TRUE))
      stop("Package not found")
  }
}

check_pkg("readr")
check_pkg("dplyr")
check_pkg("sf")
check_pkg("sp")
check_pkg("ggplot2")
check_pkg("lubridate")
check_pkg("SimilarityMeasures")
check_pkg("plotly")
check_pkg("geosphere")
check_pkg("leaflet")
check_pkg("ggspatial")
check_pkg("rnaturalearth")
check_pkg("rnaturalearthdata")
check_pkg("tidyverse")

Data <- here::here()   # Data folder
```

##Load Data
```{r import GPX tracks, echo=FALSE}
# Specify the path to the folder containing GPX files
data_folder <- "Data"

# List all GPX files in the folder
gpx_files <- list.files(data_folder, pattern = "\\.gpx$", full.names = TRUE)

# Initialize an empty list to store the GPX data
gpx_list <- list()

# Loop through each GPX file and read the data
for (file in gpx_files) {
  # Read the GPX file
  gpx_sf <- st_read(file, layer = "tracks", quiet = TRUE)
  
   # Transform the coordinate system to LV95 (EPSG:2056)
  gpx_sf_transformed <- st_transform(gpx_sf, crs = 2056)
  
  # Append to the list
  gpx_list <- append(gpx_list, list(gpx_sf_transformed))
}

# Combine all the GPX data into a single sf object
gpx_all <- do.call(rbind, gpx_list)

# Modify the "type" attribute from "night hike" to "skitour"
gpx_all$type[10] <- "skitour"

# Inspect the combined data
print(gpx_all)
```

#Data Preparation
```{r data preparation, echo=FALSE}
#Outlier removal

#Interpolation to 10s sampling interval

#filter out static movement

```

```{r import road network, echo=FALSE}
#import of the road network data

# Read the shapefile
streets <- st_read("Data/Strassennetz.shp")

# Inspect the data
print(streets)
```

```{r Reduce street Data Extend, echo=FALSE}
#cut the street data extend to the buffer around GPX data

# Create a 1000-meter buffer around the GPX tracks
gpx_buffer <- st_buffer(gpx_all, dist = 1000)

# Find street segments that intersect or touch the GPX buffer
streets_intersecting <- st_intersection(streets, gpx_buffer)
```

##Explore Data
```{r EDA, echo=FALSE}
#Visualize and understand the GPX and road network data

# Plot the results
ggplot() +
  geom_sf(data = streets_intersecting, color = 'grey') +
  geom_sf(data = gpx_buffer, fill = NA, color = 'red', size = 1) +
  theme_minimal() +
  labs(title = "Streets and GPX Buffer", x = "Longitude", y = "Latitude")

# Plot the results in a Swiss Map
# Get Switzerland basemap
switzerland <- ne_countries(country = "Switzerland", returnclass = "sf")

# Transform basemap to LV95
switzerland <- st_transform(switzerland, 2056)

ggplot() +
  geom_sf(data = switzerland, fill = "white", color = "black") +
  geom_sf(data = streets_intersecting, color = 'grey') +
  geom_sf(data = gpx_buffer, fill = NA, color = 'red', size = 1) +
  coord_sf(crs = st_crs(2056)) +
  theme_minimal() +
  labs(title = "Streets and GPX Buffer", x = "Longitude", y = "Latitude") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  theme(legend.position = "right") +
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.75, "in"),
                         style = north_arrow_fancy_orienteering)

#histograms, box plots, and scatter plots -> similarities between transportation modes

```

#Segmentation

#Function Definitions
##Speed
```{r Speed Function, echo=FALSE}
# Ensure the data is sorted by time
gpx_all <- gpx_all %>% arrange(time)

# Extract coordinates and time
coords <- st_coordinates(gpx_all)
time <- gpx_all$time

# Calculate distances between consecutive points
distances <- sqrt(diff(coords[,1])^2 + diff(coords[,2])^2)

# Calculate time differences between consecutive points in seconds
time_diffs <- as.numeric(difftime(time[-1], time[-length(time)], units = "secs"))

# Calculate speeds (m/s)
speeds <- distances / time_diffs

# Compute summary statistics
max_speed <- max(speeds, na.rm = TRUE)
avg_speed <- mean(speeds, na.rm = TRUE)
speed_variance <- var(speeds, na.rm = TRUE)

# Add the speed statistics as attributes to the sf object
gpx_all$max_speed <- max_speed
gpx_all$avg_speed <- avg_speed
gpx_all$speed_variance <- speed_variance

# Inspect the resulting sf object
print(gpx_all)



# -> we also need to import the time as an attribute
```

##Elevation Change
```{r Elevation Function, echo=FALSE}

```

##Distance to Street
```{r Fr√©chet Distance, echo=FALSE}

```

##Stop Frequency
```{r Stop Frequency Function, echo=FALSE}

```

##Add Month
```{r Add Month, echo=FALSE}

```

#Classification Model
```{r Classification Model, echo=FALSE}
#model differentiates between jogging, skitouring, hiking, biking

```

#Data Processing
```{r Data Processing, echo=FALSE}

```

#Evaluation
##Accuracy
```{r Accuracy, echo=FALSE}

```

##Precision
```{r Precision, echo=FALSE}

```

##Recall
```{r Recall, echo=FALSE}

```

##F1-Score
```{r F1-Score, echo=FALSE}

```

#Result Visualization
##Classification Visualization
```{r Classification Visualization, echo=FALSE}
#color = classification, size = uncertainty (percentage)

```

##Accuracy Visualization
```{r Accuracy Visualization, echo=FALSE}
#confusion matrices

```
